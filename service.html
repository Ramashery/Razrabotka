<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Craft</title>
    <meta name="description" content="">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <!-- Three.js -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.165.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.165.0/examples/jsm/"
        }
    }
    </script>

    <style>
        :root {
            --color-bg: #030409;
            --color-text: #FFFFFF;
            --color-accent: #b8d8e8;
            --color-border: rgba(184, 216, 232, 0.2);
        }
        body { margin: 0; padding: 0; font-family: 'Cormorant Garamond', serif; background-color: var(--color-bg); color: var(--color-text); -webkit-font-smoothing: antialiased; overflow-x: hidden; line-height: 1.6; }
        h1, h2, h3 { font-weight: 600; letter-spacing: 0.5px; }
        a { color: var(--color-accent); text-decoration: none; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--color-bg); display: flex; justify-content: center; align-items: center; z-index: 10000; transition: opacity 0.5s ease-out; }
        .spinner { width: 50px; height: 50px; border: 3px solid var(--color-accent); border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #webgl-canvas { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; }
        main { position: relative; z-index: 2; max-width: 900px; margin: 0 auto; padding: 120px 30px; transition: opacity 0.5s ease-out, transform 0.5s ease-out; }
        body.nav-is-open main { opacity: 0; transform: translateY(20px); pointer-events: none; }
        
        section { margin-bottom: 80px; perspective: 1000px; }
        .animated-container { opacity: 0; transform: translateX(-30px) rotate(-5deg); transition: all 0.7s cubic-bezier(0.2, 0.9, 0.3, 1.1); }
        .animated-container.active { opacity: 1; transform: none; }
        @keyframes letterAppear { 0% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: none; } }
        .animated-text { color: transparent; }
        .animated-text.is-animating { color: var(--color-text); }
        .animated-text span { display: inline-block; opacity: 0; animation: letterAppear 0.5s forwards; }

        .menu-toggle { position: fixed; top: 30px; right: 30px; z-index: 1000; background: transparent; border: none; padding: 0; cursor: pointer; width: 30px; height: 24px; display: flex; flex-direction: column; justify-content: space-between; transition: transform 0.4s; }
        .menu-toggle:hover { transform: scale(1.1); }
        .menu-toggle .bar { background: var(--color-text); height: 2px; width: 100%; transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); transform-origin: right; }
        .menu-toggle.is-active .bar:nth-child(1) { transform: translateY(11px) rotate(-45deg); background: var(--color-accent); }
        .menu-toggle.is-active .bar:nth-child(2) { opacity: 0; }
        .menu-toggle.is-active .bar:nth-child(3) { transform: translateY(-11px) rotate(45deg); background: var(--color-accent); }
        .nav-overlay { position: fixed; top: 0; right: -100%; width: 400px; height: 100vh; background: rgba(3, 4, 9, 0.8); backdrop-filter: blur(10px); z-index: 999; transition: right 0.6s cubic-bezier(0.77, 0, 0.175, 1); overflow: hidden; }
        .nav-overlay.is-active { right: 0; }
        .nav-menu { padding: 100px 40px; list-style: none; }
        .nav-menu li { margin-bottom: 25px; opacity: 0; transform: translateX(30px); transition: all 0.4s ease-out; }
        .nav-overlay.is-active .nav-menu li { opacity: 1; transform: translateX(0); }
        .nav-menu li:nth-child(1) { transition-delay: 0.1s; } .nav-menu li:nth-child(2) { transition-delay: 0.2s; } .nav-menu li:nth-child(3) { transition-delay: 0.3s; } .nav-menu li:nth-child(4) { transition-delay: 0.4s; } .nav-menu li:nth-child(5) { transition-delay: 0.5s; } .nav-menu li:nth-child(6) { transition-delay: 0.6s; }
        .nav-menu a { color: var(--color-text); font-size: 1.8rem; position: relative; padding-bottom: 5px; transition: all 0.3s ease-out; }
        .nav-menu a:hover { color: var(--color-accent); transform: translateX(5px); }
        .nav-menu a::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 1px; background: var(--color-accent); transition: width 0.4s; }
        .nav-menu a:hover::after { width: 100%; }
        
        .service-header { text-align: center; margin-bottom: 60px; }
        .service-header h1 { font-size: clamp(2.5rem, 7vw, 4rem); margin: 0 0 10px; line-height: 1.1; font-weight: 700; text-shadow: 0 0 15px rgba(184, 216, 232, 0.4); }
        .service-price { font-size: 1.2rem; color: var(--color-accent); letter-spacing: 1px; opacity: 0.9; }
        .service-main-image { width: 100%; height: 400px; border-radius: 8px; object-fit: cover; border: 1px solid var(--color-border); margin-bottom: 40px; transform: translateZ(0); /* РЕШЕНИЕ ПРОБЛЕМЫ МЕРЦАНИЯ */ }
        .service-content { font-size: 1.15rem; opacity: 0.95; transform: translateZ(0); /* РЕШЕНИЕ ПРОБЛЕМЫ МЕРЦАНИЯ */ }
        .service-content p { margin-bottom: 1.5em; }
        .service-gallery { margin-top: 60px; }
        .service-gallery h2 { border-bottom: 1px solid var(--color-border); padding-bottom: 10px; margin-bottom: 30px; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .gallery-grid img { width: 100%; height: auto; border-radius: 4px; border: 1px solid var(--color-border); transform: translateZ(0); /* РЕШЕНИЕ ПРОБЛЕМЫ МЕРЦАНИЯ */ }
        .gallery-grid iframe { width: 100%; aspect-ratio: 16 / 9; border: 1px solid var(--color-border); border-radius: 4px; transform: translateZ(0); /* РЕШЕНИЕ ПРОБЛЕМЫ МЕРЦАНИЯ */ }

        @media (max-width: 768px) { .nav-overlay { width: 100%; } }
        @media (max-width: 480px) { main { padding: 80px 15px; } }
    </style>
</head>
<body>
    <!-- HTML и JS остаются без изменений -->
    <div id="loader"><div class="spinner"></div></div>
    <canvas id="webgl-canvas"></canvas>
    <button class="menu-toggle" aria-label="Toggle menu"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
    <div class="nav-overlay">
        <ul class="nav-menu">
            <li><a href="index.html">Home</a></li>
            <li><a href="index.html#services">Services</a></li>
            <li><a href="index.html#portfolio">Portfolio</a></li>
            <li><a href="index.html#blog">Blog</a></li>
            <li><a href="#">Contact</a></li>
            <li><a href="index.html#admin-panel" id="admin-toggle-link">Admin</a></li>
        </ul>
    </div>
    <main id="main-content"></main>
    <script type="module">
        // Весь JavaScript код остается прежним, без изменений.
        import * as THREE from 'three';
        const firebaseConfig = { apiKey: "AIzaSyAT4dDEIDUtzP60ibjahO06P75Q6h95ZN4", authDomain: "razrabotka-b61bc.firebaseapp.com", projectId: "razrabotka-b61bc", storageBucket: "razrabotka-b61bc.firebasestorage.app", messagingSenderId: "394402564794", appId: "1:394402564794:web:f610ffb03e655c600c5083" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        async function loadServiceData() { const params = new URLSearchParams(window.location.search); const collectionName = params.get('collection'); const slug = params.get('slug'); if (!collectionName || !slug) { renderError("Page not found. Invalid URL."); return; } try { const querySnapshot = await db.collection(collectionName).where('urlSlug', '==', slug).limit(1).get(); if (querySnapshot.empty) { renderError(`Item not found in '${collectionName}' with slug '${slug}'.`); return; } const data = querySnapshot.docs[0].data(); renderServicePage(data); } catch (error) { console.error("Error loading service data:", error); renderError("Could not load page data. Please check the console."); } }
        function renderServicePage(data) { document.title = data.seoTitle || "Digital Craft"; document.querySelector('meta[name="description"]').setAttribute('content', data.metaDescription || ""); if (data.schemaJsonLd) { try { const schema = JSON.parse(data.schemaJsonLd); const script = document.createElement('script'); script.type = 'application/ld+json'; script.textContent = JSON.stringify(schema); document.head.appendChild(script); } catch (e) { console.error("Could not parse Schema JSON-LD", e); } } const main = document.getElementById('main-content'); const mainImage = data.media.find(url => !/youtube|vimeo/.test(url)); const videos = data.media.filter(url => /youtube|vimeo/.test(url)); const images = data.media.filter(url => !/youtube|vimeo/.test(url) && url !== mainImage); let galleryHTML = ''; if (images.length > 0 || videos.length > 0) { const videosGrid = videos.map(url => { const embedUrl = url.replace('watch?v=', 'embed/'); return `<div class="animated-container"><iframe src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`; }).join(''); const imagesGrid = images.map(url => `<div class="animated-container"><img src="${url}" alt="${data.mainImageAlt || data.h1}"></div>`).join(''); galleryHTML = ` <section class="service-gallery"> <h2 class="animated-container animated-text">Gallery & Media</h2> <div class="gallery-grid"> ${videosGrid} ${imagesGrid} </div> </section> `; } main.innerHTML = ` <section> <div class="service-header animated-container"> <h1 class="animated-text">${data.h1}</h1> ${data.price ? `<div class="service-price animated-text">${data.price}</div>` : ''} </div> ${mainImage ? `<img src="${mainImage}" alt="${data.mainImageAlt || data.h1}" class="service-main-image animated-container">` : ''} <div class="service-content animated-container animated-text"> ${data.mainContent.replace(/\n/g, '<p>')} </div> </section> ${galleryHTML} `; initIntersectionObservers(); }
        function renderError(message) { const main = document.getElementById('main-content'); main.innerHTML = ` <section> <div class="service-header"> <h1>Error</h1> <p>${message}</p> <a href="index.html" style="text-decoration: underline;">Go back to Home</a> </div> </section> `; }
        function initApp() { document.getElementById('loader').style.opacity = '0'; setTimeout(() => document.getElementById('loader').style.display = 'none', 500); initStaticEventListeners(); loadServiceData(); animate(); }
        window.addEventListener('load', initApp);
        function initStaticEventListeners() { const menuToggle = document.querySelector('.menu-toggle'); const navOverlay = document.querySelector('.nav-overlay'); menuToggle.addEventListener('click', () => { document.body.classList.toggle('nav-is-open'); menuToggle.classList.toggle('is-active'); navOverlay.classList.toggle('is-active'); }); document.querySelectorAll('.nav-menu a').forEach(link => { if (link.id !== 'admin-toggle-link') { link.addEventListener('click', () => { if (document.body.classList.contains('nav-is-open')) { document.body.classList.remove('nav-is-open'); menuToggle.classList.remove('is-active'); navOverlay.classList.remove('is-active'); } }); } }); document.getElementById('admin-toggle-link').addEventListener('click', (e) => { e.preventDefault(); window.location.href = 'index.html'; }); }
        function animateTextLetters(element) { if (!element || element.dataset.animated) return; element.dataset.animated = true; element.classList.add('is-animating'); const text = element.textContent.trim(); element.innerHTML = ''; const words = text.split(/\s+/); words.forEach((word, wordIndex) => { const wordWrapper = document.createElement('span'); wordWrapper.style.display = 'inline-block'; word.split('').forEach((char) => { const span = document.createElement('span'); span.textContent = char; span.style.animationDelay = `${Math.random() * 0.5}s`; wordWrapper.appendChild(span); }); element.appendChild(wordWrapper); if (wordIndex < words.length - 1) { element.appendChild(document.createTextNode(' ')); } }); }
        function activateContainer(container) { if (container.classList.contains('active')) return; container.classList.add('active'); const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches; if (prefersReducedMotion) { container.querySelectorAll('.animated-text').forEach(animateTextLetters); return; } setTimeout(() => { if (container.classList.contains('animated-text')) { animateTextLetters(container); } else { container.querySelectorAll('.animated-text').forEach(animateTextLetters); } }, 300); }
        let observer; function initIntersectionObservers() { if (observer) observer.disconnect(); observer = new IntersectionObserver((entries, obs) => { entries.forEach(entry => { if (entry.isIntersecting) { const section = entry.target; const containers = section.querySelectorAll('.animated-container'); containers.forEach((container, index) => { setTimeout(() => activateContainer(container), index * 150); }); obs.unobserve(section); } }); }, { threshold: 0.2 }); document.querySelectorAll("main > section").forEach(section => observer.observe(section)); }
        let crystalMaterial; const scene = new THREE.Scene(); const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000); camera.position.z = 5; const canvas = document.getElementById("webgl-canvas"); const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true }); renderer.setSize(window.innerWidth, window.innerHeight); renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); scene.add(new THREE.AmbientLight(0x404040, 2)); const pointLight1 = new THREE.PointLight(0x00aaff, 30, 20); pointLight1.position.set(5, 5, 5); scene.add(pointLight1); const crystalGroup = new THREE.Group(); scene.add(crystalGroup); crystalMaterial = new THREE.ShaderMaterial({ uniforms: { time: { value: 0 }, color1: { value: new THREE.Color(0xb8d8e8) }, color2: { value: new THREE.Color(0x1d2a3a) }, }, vertexShader: `varying vec3 vNormal; varying vec3 vPosition; void main() { vNormal = normalize(normalMatrix * normal); vPosition = position; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`, fragmentShader: `uniform float time; uniform vec3 color1; uniform vec3 color2; varying vec3 vNormal; float snoise(vec3 v){ const vec2 C = vec2(1.0/6.0, 1.0/3.0) ; const vec4 D = vec4(0.0, 0.5, 1.0, 2.0); vec3 i = floor(v + dot(v, C.yyy) ); vec3 x0 = v - i + dot(i, C.xxx) ; vec3 g = step(x0.yzx, x0.xyz); vec3 l = 1.0 - g; vec3 i1 = min( g.xyz, l.zxy ); vec3 i2 = max( g.xyz, l.zxy ); vec3 x1 = x0 - i1 + C.xxx; vec3 x2 = x0 - i2 + C.yyy; vec3 x3 = x0 - D.yyy; i = mod(i, 289.0); vec4 p = mod(((i.z + vec4(0.0, i1.z, i2.z, 1.0 ))*34.0+1.0)* (i.z + vec4(0.0, i1.z, i2.z, 1.0 )) + i.y + vec4(0.0, i1.y, i2.y, 1.0 ), 289.0); p = mod(((p)*34.0+1.0)*(p) + i.x + vec4(0.0, i1.x, i2.x, 1.0 ), 289.0); vec4 j = p - 49.0 * floor(p * (1.0/7.0) * (1.0/7.0)); vec4 x_ = floor(j * (1.0/7.0)); vec4 y_ = floor(j - 7.0 * x_ ); vec4 x = x_ * (2.0/7.0) - 1.0 + (1.0/7.0); vec4 y = y_ * (2.0/7.0) - 1.0 + (1.0/7.0); vec4 h = 1.0 - abs(x) - abs(y); vec4 b0 = vec4( x.xy, y.xy ); vec4 b1 = vec4( x.zw, y.zw ); vec4 s0 = floor(b0)*2.0 + 1.0; vec4 s1 = floor(b1)*2.0 + 1.0; vec4 sh = -step(h, vec4(0.0)); vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ; vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ; vec3 p0 = vec3(a0.xy,h.x); vec3 p1 = vec3(a0.zw,h.y); vec3 p2 = vec3(a1.xy,h.z); vec3 p3 = vec3(a1.zw,h.w); vec4 norm = inversesqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2,p2), dot(p3,p3))); p0 *= norm.x; p1 *= norm.y; p2 *= norm.z; p3 *= norm.w; vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0); m = m * m; return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), dot(p2,x2), dot(p3,x3) ) ); } void main() { float noise = snoise(vNormal * 3.0 + time * 0.1); vec3 baseColor = mix(color1, color2, vNormal.y * 0.5 + 0.5); float fresnel = pow(1.0 - abs(dot(vNormal, vec3(0.0, 0.0, 1.0))), 3.0); vec3 finalColor = baseColor + fresnel * vec3(0.8, 0.9, 1.0) * 0.5; finalColor += noise * 0.2; gl_FragColor = vec4(finalColor, fresnel * 0.8 + 0.2); }`, transparent: true, blending: THREE.AdditiveBlending, depthWrite: false, });
        const coreCrystal = new THREE.Mesh(new THREE.IcosahedronGeometry(0.8, 1), crystalMaterial); crystalGroup.add(coreCrystal); let branches = []; let crystalGrowth = 0;
        const addBranch = () => { if (branches.length > 50) return; const branch = new THREE.Mesh(new THREE.IcosahedronGeometry(0.1 + Math.random() * 0.4, 0), crystalMaterial); const phi = Math.random() * Math.PI * 2, theta = Math.acos(Math.random() * 2 - 1), radius = 1 + Math.random() * crystalGrowth; branch.position.set(radius * Math.sin(theta) * Math.cos(phi), radius * Math.sin(theta) * Math.sin(phi), radius * Math.cos(theta)); branch.rotation.set(Math.random(), Math.random(), Math.random()); branch.scale.set(0.01, 0.01, 0.01); crystalGroup.add(branch); branches.push({ mesh: branch, life: 0, maxLife: 0.5 + Math.random() * 1.5 }); };
        const clock = new THREE.Clock(); let scrollFraction = 0, introComplete = false; const introDuration = 5;
        function animate() { requestAnimationFrame(animate); const elapsedTime = clock.getElapsedTime(); crystalMaterial.uniforms.time.value = elapsedTime; let introProgress = introComplete ? 1.0 : Math.min(elapsedTime / introDuration, 1.0); if (introProgress >= 1.0) introComplete = true; crystalGrowth = Math.max(introProgress * 1.5, Math.min(scrollFraction * 5, 2.5)); if (crystalGrowth > 0.1 && Math.random() > 0.9) addBranch(); camera.position.z = 5 - Math.max(introProgress * 1.0, scrollFraction * 2); camera.position.y = scrollFraction * 1; camera.lookAt(scene.position); crystalGroup.rotation.y += 0.001; crystalGroup.rotation.x += 0.0005; coreCrystal.scale.setScalar(1 + crystalGrowth * 0.5); branches.forEach(b => { if (b.life < b.maxLife) { b.life += 0.01; b.mesh.scale.setScalar(Math.sin(b.life / b.maxLife * Math.PI * 0.5)); } }); renderer.render(scene, camera); }
        window.addEventListener("scroll", () => { const scrollableHeight = document.body.scrollHeight - window.innerHeight; scrollFraction = scrollableHeight > 0 ? window.scrollY / scrollableHeight : 0; });
        window.addEventListener("resize", () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
    </script>
</body>
</html>